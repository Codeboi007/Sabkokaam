<!-- templates/face_matching.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Face Matching App</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.12.0/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@0.8/dist/teachablemachine-image.min.js"></script>
  
    <script>
        async function init() {
            const modelURL = "https://teachablemachine.withgoogle.com/models/YOUR_MODEL_URL/model.json";
            const metadataURL = "https://teachablemachine.withgoogle.com/models/YOUR_MODEL_URL/metadata.json";

            model = await tmImage.load(modelURL, metadataURL);
            maxPredictions = model.getTotalClasses();

            const webcamElement = document.getElementById('webcam');
            const labelContainer = document.getElementById('label-container');
            for (let i = 0; i < maxPredictions; i++) {
                labelContainer.appendChild(document.createElement('div'));
            }

            const loadModelButton = document.getElementById('load-model-button');
            loadModelButton.addEventListener('click', async () => {
                await init();
                webcamElement.style.display = 'block';
                await predict();
            });

            const captureButton = document.getElementById('capture-button');
            captureButton.addEventListener('click', async () => {
                const snapshot = document.getElementById('snapshot');
                snapshot.src = webcamElement.toDataURL('image/png');
                snapshot.style.display = 'block';

                const prediction = await model.predict(webcamElement);
                const referencePhoto = document.getElementById('reference-photo').files[0];
                const referenceCanvas = document.getElementById('reference-canvas');

                if (referencePhoto) {
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        const img = new Image();
                        img.onload = function() {
                            referenceCanvas.width = img.width;
                            referenceCanvas.height = img.height;
                            const ctx = referenceCanvas.getContext('2d');
                            ctx.drawImage(img, 0, 0);
                            compareFaces(snapshot, referenceCanvas);
                        };
                        img.src = event.target.result;
                    };
                    reader.readAsDataURL(referencePhoto);
                } else {
                    alert('Please select a reference photo.');
                }
            });

            async function predict() {
                const prediction = await model.predict(webcamElement);
                for (let i = 0; i < maxPredictions; i++) {
                    const classPrediction = prediction[i].className + ": " + Math.floor(prediction[i].probability * 100) + '%';
                    labelContainer.childNodes[i].innerHTML = classPrediction;
                }
            }

            function compareFaces(snapshot, referenceCanvas) {
                const snapshotCanvas = document.createElement('canvas');
                snapshotCanvas.width = snapshot.width;
                snapshotCanvas.height = snapshot.height;
                const snapshotCtx = snapshotCanvas.getContext('2d');
                snapshotCtx.drawImage(snapshot, 0, 0);

                const snapshotData = snapshotCtx.getImageData(0, 0, snapshotCanvas.width, snapshotCanvas.height);
                const referenceData = referenceCanvas.getContext('2d').getImageData(0, 0, referenceCanvas.width, referenceCanvas.height);

                // Simple pixel comparison (for demonstration purposes)
                let matchCount = 0;
                for (let i = 0; i < snapshotData.data.length; i += 4) {
                    if (
                        snapshotData.data[i] === referenceData.data[i] &&
                        snapshotData.data[i + 1] === referenceData.data[i + 1] &&
                        snapshotData.data[i + 2] === referenceData.data[i + 2]
                    ) {
                        matchCount++;
                    }
                }

                const matchPercentage = (matchCount / (snapshotData.data.length / 4)) * 100;
                if (matchPercentage > 80) {
                    alert('Match Found!');
                } else {
                    alert('No Match Found.');
                }
            }
        }

        window.onload = init;
    </script>
</head>
<body>
    <h1>Face Matching App</h1>
    <form id="upload-form" enctype="multipart/form-data">
        <label for="reference-photo">Upload Reference Photo:</label>
        <input type="file" id="reference-photo" accept="image/*" required>
        <button type="button" id="load-model-button">Start Camera</button>
    </form>
    <div id="camera-container">
        <video id="webcam" autoplay playsinline style="display: none;"></video>
        <img id="snapshot" alt="Snapshot" style="display: none;">
        <canvas id="reference-canvas" style="display: none;"></canvas>
    </div>
    <button type="button" id="capture-button" style="display: none;">Capture Photo</button>
    <div id="label-container"></div>
</body>
</html>